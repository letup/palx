#整合lua console的用法

# 大略 #

类似仙三隐藏控制台的用法，不过是一个单独的win32 console。此控制台直接援引了lua解释器的源代码(原作为MIT license，引用到的文件同时作了MIT license的申明)，同时虚拟机开启了全部库的权限，可作为全功能的lua解释器使用。从游戏中直接暴露出来的接口下详。

# 注意 #

由于设计时只考虑了原脚本的需求，而原脚本是没有越界之类情况的，因此脚本的权限未予任何限制。任何超出原设计范畴的参数都可能引发崩溃。慎之。

# 细节 #

当前导出的类、函数及对象：参见svn里src/luabinding.cpp:luabinding::init()。

因涉及实现，大概说下概念：每个MKF文件有自己同名的对应对象，都被导出。以该对象之名调用getlocation(int N,int N2,int loc)函数可以获取第N个子文件第N2个二级子文件在loc偏移处的字的值，setlocation(int N,int N2,int loc,short data)函数可以写该值。中间的层次，诸如第二层是smkf还是mkf，哪层是否有YJ1压缩，不必关心。没有第二层结构的可以直接把N2填0。

get\_rpg(int)和set\_rpg(int,short):对存档结构的类似封装，直接当作平坦的字组。注意凡是要入存档的结构都要直接在这里改，比如data@3、sss@0等。

process\_script和process\_script\_entry：前者可以直接调用成段的脚本，但因为环境不足，程序多半会乱掉。后者是单独执行一条脚本，参数均可自行设定，除掉脚本号及其参数四个参数，下一个参数为返回前者在程序内的调用所用，可自填0；最后一个指定作用对象，用法多样，用于NPC则给定其在当前场景内的序号，用于主角则给定主角在队内的序号，可参看代码。

## 示例 ##

> print(DATA::getlocation(1,0,0xe8))
# 打印黑毛小妖的HP

> set\_rpg(0xC,3)
# 更改排头之人的方向为向南

> process\_script\_entry(0x59,5)
# 即时更改场景看看？怪不得半夜不让去市场，敢情都还在那练摊……

# 展望 #

除掉这种主要是检验和测试用途的控制台，lua应该会融入到现有的脚本系统内，从而缓解现有脚本灵活性和延伸程度的不足，应用到诸如战斗AI之类以前很难处理的地方。除此之外，诸如启动后导入一个脚本然后控制整个游戏走完整个流程看剧情之类，也将不再是梦想。更多的应用有待发掘:)